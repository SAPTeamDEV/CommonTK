<?xml version="1.0" encoding="utf-8"?>
<Project>
  <PropertyGroup>
    <PackageVulnerabilityCheck_AssetFile Condition="Exists('$(ProjectDir)packages.lock.json')">$(ProjectDir)packages.lock.json</PackageVulnerabilityCheck_AssetFile>
    <PackageVulnerabilityCheck_AssetFile Condition=" '$(PackageVulnerabilityCheck_AssetFile)' == '' ">$(ProjectAssetsFile)</PackageVulnerabilityCheck_AssetFile>
    <PackageVulnerabilityCheck_Stamp>$(BaseIntermediateOutputPath)vulnerability.scan.stamp</PackageVulnerabilityCheck_Stamp>
  </PropertyGroup>

  <Target Name="PackageVulnerabilityCheck"
          AfterTargets="PrepareForBuild"
          Condition="'$(Configuration)' != 'Debug'"
          Inputs="$(PackageVulnerabilityCheck_AssetFile)"
          Outputs="$(PackageVulnerabilityCheck_Stamp)">

    <Message Importance="normal" Text="Running package vulnerability checks..." />
    
    <Exec Command='dotnet list "$(MSBuildProjectFile)" package --vulnerable -v normal -f $(TargetFramework)'
          ConsoleToMSBuild="true"
		  StandardOutputImportance="Normal"
		  StandardErrorImportance="High"
		  WorkingDirectory="$(MSBuildProjectDirectory)"
          ContinueOnError="false" />

    <WriteLinesToFile File="$(PackageVulnerabilityCheck_Stamp)"
                      Lines="Scanned $(PackageVulnerabilityCheck_AssetFile) at $([System.DateTime]::UtcNow.ToString('yyyy-MM-ddTHH:mm:ssZ'))"
                      Overwrite="true" />
  </Target>
</Project>
